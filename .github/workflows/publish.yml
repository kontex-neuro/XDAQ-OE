name: Publish XDAQ-OE

on:
    workflow_dispatch:
    push:
        tags:
            - "xdaq-v*"

jobs:
    build:
        uses: ./.github/workflows/build.yml

    merge_macos:
        runs-on: macos-15
        needs: build
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Merge macOS universal bundle
              run: |
                  set -e
                  mkdir dist/output

                  if [[ ! -f dist/mac-arm64/mac-arm64.zip || ! -f dist/mac-x86_64/mac-x86_64.zip ]]; then
                      echo "Missing mac-arm64.zip or mac-x86_64.zip"
                      exit 1
                  fi
                  unzip -q dist/mac-arm64/mac-arm64.zip -d dist/mac-arm64
                  unzip -q dist/mac-x86_64/mac-x86_64.zip -d dist/mac-x86_64

                  ./scripts/merge_universal.sh \
                      dist/mac-arm64/plugins/XDAQ-OE.bundle \
                      dist/mac-x86_64/plugins/XDAQ-OE.bundle \
                      dist/mac-universal/plugins/XDAQ-OE.bundle
                  7za a dist/mac-universal.zip ./dist/mac-universal/*

            - name: Upload merged macOS bundle
              uses: actions/upload-artifact@v4
              with:
                  name: mac-universal
                  path: dist/mac-universal.zip

    publish:
        runs-on: ubuntu-24.04
        needs: [merge_macos]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Extract API Version
              run: |
                  set -e
                  git submodule update --init
                  echo PLUGIN_API=$(grep plugin-GUI/Source/Processors/PluginManager/OpenEphysPlugin.h \
                    -e '#define PLUGIN_API_VER' | \
                    sed -E 's/^#define[[:space:]]+PLUGIN_API_VER[[:space:]]+([0-9]+)/\1/') >> $GITHUB_ENV

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Flatten dist folder
              run: |
                  find dist -name '*.zip' -exec mv {} dist/ \;
                  find dist -mindepth 1 -type d -exec rm -rf {} +
                  ls -la dist

            - name: Upload to Artifactory
              run: |
                  set -e

                  # Ensure this is a tag in the form xdaq-v*
                  ref="${{ github.ref_name }}"
                  if [[ "$ref" != xdaq-v* ]]; then
                      echo "Not a release tag: $ref"
                      ref="xdaq-v0.0.0"  # Default to a dummy version if not a valid tag
                  fi

                  upload_tag="${ref#xdaq-v}"
                  api_ver="$PLUGIN_API"

                  if [[ -z dist/windows-x86_64 ]]; then
                        echo "Missing dist/windows-x86_64"
                        exit 1
                  fi
                  win_new_name="XDAQ-windows_${upload_tag}-API${api_ver}.zip"
                  mv dist/windows-x86_64.zip dist/$win_new_name
                  echo "Created: dist/$win_new_name"

                  if [[ -z dist/mac-universal ]]; then
                        echo "Missing dist/mac-universal"
                        exit 1
                  fi
                  mac_new_name="XDAQ-mac_${upload_tag}-API${api_ver}.zip"
                  mv dist/mac-universal.zip dist/$mac_new_name
                  echo "Created: dist/$mac_new_name"

                  if [[ -z dist/linux-x86_64 ]]; then
                          echo "Missing dist/linux-x86_64"
                          exit 1
                  fi
                  linux_new_name="XDAQ-linux_${upload_tag}-API${api_ver}.zip"
                  mv dist/linux-x86_64.zip dist/$linux_new_name
                  echo "Created: dist/$linux_new_name"

                  if [[ -z "${{ secrets.artifactoryApiKey }}" ]]; then
                      echo "No Artifactory API key set, skipping upload"
                      exit 0
                  fi

                  curl -H "X-JFrog-Art-Api:${{ secrets.artifactoryApiKey }}" -T "dist/$win_new_name" \
                    "https://openephys.jfrog.io/artifactory/XDAQ-plugin/windows/$win_new_name"
                  curl -H "X-JFrog-Art-Api:${{ secrets.artifactoryApiKey }}" -T "dist/$mac_new_name" \
                    "https://openephys.jfrog.io/artifactory/XDAQ-plugin/mac/$mac_new_name"
                  curl -H "X-JFrog-Art-Api:${{ secrets.artifactoryApiKey }}" -T "dist/$linux_new_name" \
                    "https://openephys.jfrog.io/artifactory/XDAQ-plugin/linux/$linux_new_name"

            - name: Upload dist folder
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist
